<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间线笔记</title>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://mfqonqbufimxjvoewfaf.supabase.co">
    <!-- Preload 关键脚本 -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" as="script">
    <link rel="stylesheet" href="css/style.css?v=20250124">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="images/icon.svg">
    <link rel="apple-touch-icon" href="images/icon.svg">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>

    <!-- SVG Defs for Mood Icons -->
    <svg style="display: none;">
        <defs>
            <!-- Sunny Icon: Sun with rays -->
            <symbol id="icon-sunny" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M12 2V4M12 20V22M4.93 4.93L6.34 6.34M17.66 17.66L19.07 19.07M2 12H4M20 12H22M4.93 19.07L6.34 17.66M17.66 6.34L19.07 4.93" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </symbol>
            
            <!-- Cloudy Icon: Cloud shape -->
            <symbol id="icon-cloudy" viewBox="0 0 24 24">
                <path d="M17.5 19C19.9853 19 22 16.9853 22 14.5C22 12.132 20.177 10.244 17.8 8.05C17.45 4.96 14.99 2.5 12 2.5C9.01 2.5 6.55 4.96 6.2 8.05C3.83 8.25 2 10.13 2 12.5C2 14.99 4.015 17 6.5 17H17.5Z" stroke="currentColor" stroke-width="2" fill="none" stroke-linejoin="round"/>
            </symbol>
            
            <!-- Rainy Icon: Cloud with rain drops -->
            <symbol id="icon-rainy" viewBox="0 0 24 24">
                <path d="M17.5 17C19.9853 17 22 14.9853 22 12.5C22 10.132 20.177 8.244 17.8 8.05C17.45 4.96 14.99 2.5 12 2.5C9.01 2.5 6.55 4.96 6.2 8.05C3.83 8.25 2 10.13 2 12.5C2 14.99 4.015 17 6.5 17H17.5Z" stroke="currentColor" stroke-width="2" fill="none" stroke-linejoin="round"/>
                <path d="M8 22V20M12 22V20M16 22V20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </symbol>
        </defs>
    </svg>

    <div id="app" v-cloak>

        <!-- iOS 风格导航栏 -->
        <nav class="navbar">
            <div class="navbar-content">
                <h1 class="nav-title">嗷嗷日记本</h1>
                <div class="navbar-actions">
                    <button class="icon-btn-nav" @click="openFilterModal">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                            <path d="M4 6H20M4 12H20M4 18H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="17" cy="18" r="3" fill="currentColor"/>
                        </svg>
                    </button>
                    <button class="compose-btn" @click="openComposeModal">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <!-- 主内容区 -->
        <main class="main-container" ref="mainContainer">
            <!-- 下拉刷新指示器 -->
            <div class="pull-to-refresh" :class="{ 'loading': isPullRefreshing }" :style="{ transform: `translateY(${pullRefreshTranslateY}px)` }">
                <div class="pull-indicator">
                    <svg v-if="!isPullRefreshing" class="pull-icon" :class="{ 'rotated': pullRefreshRotate }" width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M19 9L15 5L11 9M15 5V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <div v-else class="pull-spinner"></div>
                    <span class="pull-text">{{ pullRefreshText }}</span>
                </div>
            </div>

            <!-- 加载状态 -->
            <div v-if="isLoading" class="loading-state">
                <div class="loading-spinner"></div>
                <p class="loading-text">{{ loadingText }}</p>
            </div>

            <!-- 错误状态 -->
            <div v-else-if="loadError" class="error-state">
                <svg class="error-icon" width="64" height="64" viewBox="0 0 64 64" fill="none">
                    <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="2"/>
                    <path d="M32 22V32M32 38V42" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
                <p class="error-title">加载失败</p>
                <p class="error-message">{{ loadError }}</p>
                <button class="retry-btn" @click="loadNotes">重试</button>
            </div>

            <!-- 正常内容 -->
            <template v-else>
            <!-- 横向时间线布局 -->
            <div class="timeline-wrapper">
                <!-- 横向时间线 -->
                <div class="timeline-horizontal"></div>

                <!-- 笔记卡片区域 - 自动换行 -->
                <div class="notes-flow">
                    <article
                        v-for="note in displayNotes"
                        :key="note.id"
                        class="note-card"
                        :class="{ 'has-image': (note.images && note.images.length) || note.image, 'is-favorite': note.favorite }"
                        @click="openNoteDetail(note)"
                    >
                        <!-- 时间点 (增加心情颜色 class) -->
                        <div class="note-dot-wrapper">
                            <!-- 收藏状态：黄色圆点 -->
                            <div v-if="note.favorite" class="note-dot is-favorite-dot"></div>
                            <!-- 晴天：太阳图标 -->
                            <div v-else-if="note.mood === 'sunny'" class="note-dot-icon mood-sunny">
                                <svg width="14" height="14" viewBox="0 0 24 24"><use href="#icon-sunny"></use></svg>
                            </div>
                            <!-- 雨天：雨图标 -->
                            <div v-else-if="note.mood === 'rainy'" class="note-dot-icon mood-rainy">
                                <svg width="14" height="14" viewBox="0 0 24 24"><use href="#icon-rainy"></use></svg>
                            </div>
                            <!-- 默认/阴天：蓝色圆点 -->
                            <div v-else class="note-dot mood-default"></div>
                        </div>

                        <!-- 卡片内容 -->
                        <div class="card-inner">
                            <!-- 皇冠收藏按钮 -->
                            <button class="favorite-btn" :class="{ 'active': note.favorite }" @click="onFavoriteClick($event, note)">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                    <path d="M5 16H19V21H5V16Z" fill="currentColor"/>
                                </svg>
                            </button>
                            <div class="card-header">
                                <span class="card-time">{{ formatDetailTime(note.timestamp) }}</span>
                            </div>

                            <p class="card-text">{{ note.text }}</p>

                            <!-- 图片 - 兼容新旧数据 -->
                            <img v-if="note.images && note.images.length" :src="getThumbnailUrl(note.images[0])" class="card-image" alt="">
                            <img v-else-if="note.image" :src="getThumbnailUrl(note.image)" class="card-image" alt="">

                            <!-- 标签和点赞行 -->
                            <div class="card-actions-row">
                                <div class="card-tags">
                                    <span
                                        v-for="tag in (note.tags || [])"
                                        :key="tag"
                                        class="card-tag"
                                        :style="{ color: getTagColor(tag), background: getTagColor(tag) + '1A' }"
                                    >
                                        #{{ tag }}
                                    </span>
                                </div>
                                <!-- 点赞按钮 -->
                                <button class="like-btn" :class="{ 'active': note.liked }" @click="onLikeClick($event, note)">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                    </svg>
                                    <span class="like-count" v-if="note.likecount > 0">{{ note.likecount }}</span>
                                </button>
                            </div>

                            <!-- 卡片底部 -->
                            <div class="card-footer">
                                <span class="card-date">{{ formatTime(note.timestamp) }}</span>
                                <svg class="chevron" width="14" height="14" viewBox="0 0 16 16" fill="none">
                                    <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                    </article>

                    <!-- 加载更多提示 -->
                    <div v-if="isLoadingMore" class="loading-more">
                        <div class="loading-spinner-small"></div>
                        <span>加载更多...</span>
                    </div>

                    <!-- 空状态 -->
                    <div v-if="displayNotes.length === 0 && !isLoading" class="empty-state">
                        <svg class="empty-icon" width="64" height="64" viewBox="0 0 64 64" fill="none">
                            <rect x="8" y="8" width="48" height="48" rx="12" stroke="currentColor" stroke-width="2"/>
                            <path d="M20 32H44M32 20V44" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <p class="empty-title">{{ notes.length === 0 ? '还没有笔记' : '没有符合条件的笔记' }}</p>
                        <p class="empty-subtitle">{{ notes.length === 0 ? '点击右上角的 + 号创建第一条笔记' : '试试调整筛选条件' }}</p>
                    </div>
                </div>
            </div>
            </template>
        </main>

        <!-- 新建笔记弹窗 -->
        <transition name="modal">
            <div v-if="showComposeModal" class="modal-backdrop" @click.self="closeComposeModal">
                <div class="compose-modal">
                    <div class="compose-header">
                        <button class="header-btn" @click="closeComposeModal">取消</button>
                        <h2 class="compose-title">新笔记</h2>
                        <button class="header-btn header-btn-primary" @click="saveNote" :disabled="!canPost || isSaving">
                            {{ isSaving ? '发布中...' : '发布' }}
                        </button>
                    </div>

                    <div class="compose-body">
                        <!-- 默认标签选择 -->
                        <div class="default-tags-section">
                            <span
                                v-for="tag in defaultTags"
                                :key="tag.name"
                                class="default-tag-chip"
                                :class="{ 'selected': isTagSelected(tag.name) }"
                                :style="{ '--tag-color': tag.color }"
                                @click="selectDefaultTag(tag.name)"
                            >
                                #{{ tag.name }}
                            </span>
                        </div>

                        <textarea
                            v-model="newNote.text"
                            class="compose-textarea"
                            placeholder="在想什么？"
                            rows="5"
                            maxlength="280"
                            ref="composeTextarea"
                        ></textarea>
                        <div class="char-counter">
                            <span :class="{ 'over-limit': newNote.text.length > 280 }">
                                {{ newNote.text.length }}
                            </span>/280
                        </div>

                        <!-- 图片预览区 - 九宫格布局支持拖拽排序 -->
                        <div v-if="newNote.images && newNote.images.length" class="images-attachment" :class="`images-count-${Math.min(newNote.images.length, 9)}`">
                            <div
                                v-for="(img, index) in newNote.images"
                                :key="index"
                                class="image-preview-item"
                                :data-index="index"
                            >
                                <img :src="img.preview" alt="" draggable="false">
                                <button class="remove-attachment" @click="removeImage(index)">×</button>
                            </div>
                        </div>

                        <!-- 标签输入 -->
                        <div class="tags-section">
                            <div v-if="newNote.tags.length > 0" class="tags-list">
                                <span
                                    v-for="(tag, index) in newNote.tags"
                                    :key="index"
                                    class="tag-chip"
                                    :style="{ color: getTagColor(tag), background: getTagColor(tag) + '1A' }"
                                >
                                    #{{ tag }}
                                    <button @click="removeTag(index)" class="tag-remove">
                                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                                            <path d="M2 2L10 10M2 10L10 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                </span>
                            </div>
                            <input
                                v-model="tagInput"
                                class="tag-input-field"
                                placeholder="#标签名"
                                @keyup.enter="addTag"
                                @keyup.space="addTag"
                            >
                        </div>
                    </div>

                    <div class="compose-toolbar">
                        <!-- 图片上传按钮 -->
                        <button class="toolbar-btn" @click="triggerImageUpload">
                            <input type="file" ref="fileInput" accept="image/*" multiple @change="handleImageUpload" class="hidden-input">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        
                        <!-- 标签按钮 -->
                        <button class="toolbar-btn" @click="focusTagInput">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M7 10H17M7 14H13M7 18H10M21 6V18C21 19.1 20.1 20 19 20H5C3.9 20 3 19.1 3 18V6C3 4.9 3.9 4 5 4H19C20.1 4 21 4.9 21 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>

                        <!-- 心情选择按钮 -->
                        <div class="mood-selector-container">
                            <button 
                                class="toolbar-btn" 
                                :class="`mood-btn-${newNote.mood}`"
                                @click="toggleMoodSelector"
                            >
                                <svg width="24" height="24">
                                    <use :href="`#icon-${newNote.mood}`"></use>
                                </svg>
                            </button>
                            
                            <!-- 心情选择气泡 -->
                            <transition name="fade">
                                <div v-if="showMoodSelector" class="mood-selector-bubble">
                                    <button 
                                        class="mood-option" 
                                        :class="{ active: newNote.mood === 'sunny' }"
                                        data-mood="sunny"
                                        @click="selectMood('sunny')"
                                    >
                                        <svg width="20" height="20"><use href="#icon-sunny"></use></svg>
                                    </button>
                                    <button 
                                        class="mood-option" 
                                        :class="{ active: newNote.mood === 'cloudy' }"
                                        data-mood="cloudy"
                                        @click="selectMood('cloudy')"
                                    >
                                        <svg width="20" height="20"><use href="#icon-cloudy"></use></svg>
                                    </button>
                                    <button 
                                        class="mood-option" 
                                        :class="{ active: newNote.mood === 'rainy' }"
                                        data-mood="rainy"
                                        @click="selectMood('rainy')"
                                    >
                                        <svg width="20" height="20"><use href="#icon-rainy"></use></svg>
                                    </button>
                                </div>
                            </transition>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 图片查看器弹窗 -->
        <transition name="modal">
            <div v-if="showImageViewer" class="modal-backdrop image-viewer-backdrop" @click.self="closeImageViewer">
                <div class="image-viewer-container">
                    <!-- 关闭按钮 -->
                    <button class="image-viewer-close" @click="closeImageViewer">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>

                    <!-- 上一张按钮 -->
                    <button
                        v-if="viewerImages.length > 1 && viewerIndex > 0"
                        class="image-viewer-nav image-viewer-prev"
                        @click="viewerPrev"
                    >
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>

                    <!-- 当前图片 -->
                    <img :src="viewerImages[viewerIndex]" class="image-viewer-image" alt="">

                    <!-- 下一张按钮 -->
                    <button
                        v-if="viewerImages.length > 1 && viewerIndex < viewerImages.length - 1"
                        class="image-viewer-nav image-viewer-next"
                        @click="viewerNext"
                    >
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>

                    <!-- 图片计数 -->
                    <div v-if="viewerImages.length > 1" class="image-viewer-counter">
                        {{ viewerIndex + 1 }} / {{ viewerImages.length }}
                    </div>
                </div>
            </div>
        </transition>

        <!-- 笔记详情弹窗 -->
        <transition name="modal">
            <div v-if="showDetailModal" class="modal-backdrop" @click.self="closeDetailModal">
                <div class="detail-modal">
                    <div class="detail-header">
                        <button class="header-btn" @click="closeDetailModal">关闭</button>
                        <div class="header-actions">
                            <button class="icon-btn" @click="deleteCurrentNote">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path d="M3.5 5H16.5M8.5 5V3.5H11.5V5M6.5 5V15.5C6.5 16.05 6.95 16.5 7.5 16.5H12.5C13.05 16.5 13.5 16.05 13.5 15.5V5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="detail-content" v-if="selectedNote">
                        <p class="detail-text">{{ selectedNote.text }}</p>

                        <!-- 所有图片 - 九宫格布局 - 点击查看大图 -->
                        <div v-if="selectedNote.images && selectedNote.images.length" class="detail-images" :class="`images-count-${Math.min(selectedNote.images.length, 9)}`">
                            <img
                                v-for="(img, index) in selectedNote.images"
                                :key="index"
                                :src="img"
                                class="detail-image"
                                alt=""
                                @click="openImageViewer(selectedNote.images, index)"
                            >
                        </div>
                        <img v-else-if="selectedNote.image" :src="selectedNote.image" class="detail-image detail-image-single" alt="" @click="openImageViewer([selectedNote.image], 0)">

                        <!-- 标签编辑区 -->
                        <div class="detail-tags-edit">
                            <div class="detail-tags-list">
                                <span
                                    v-for="tag in selectedNote.tags"
                                    :key="tag"
                                    class="detail-tag"
                                    :style="{ color: getTagColor(tag), background: getTagColor(tag) + '1A' }"
                                >
                                    #{{ tag }}
                                    <button @click="removeDetailTag(tag)" class="detail-tag-remove">
                                        <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                            <path d="M1 1L9 9M1 9L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                </span>
                            </div>
                            <input
                                v-model="detailTagInput"
                                class="detail-tag-input"
                                placeholder="#标签名"
                                @keyup.enter="addDetailTag"
                                @keyup.space="addDetailTag"
                            >
                        </div>

                        <div class="detail-meta">
                            <div class="detail-date-container">
                                <!-- 心情图标 -->
                                <div class="mood-icon-detail" :class="selectedNote.mood || 'cloudy'">
                                    <svg width="18" height="18">
                                        <use :href="'#icon-' + (selectedNote.mood || 'cloudy')"></use>
                                    </svg>
                                </div>
                                <span class="detail-date">{{ formatDetailTime(selectedNote.timestamp) }}</span>
                            </div>

                            <button class="like-btn" :class="{ 'active': selectedNote.liked }" @click="onLikeClick($event, selectedNote)">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                </svg>
                                <span class="like-count" v-if="selectedNote.likecount > 0">{{ selectedNote.likecount }}</span>
                            </button>
                        </div>

                        <!-- 评论区 -->
                        <div class="detail-comments-section">
                            <button class="comments-toggle" @click="toggleComments">
                                <span class="comments-toggle-title">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                        <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2v10z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    评论 ({{ getSelectedNoteComments().length }})
                                </span>
                                <svg class="chevron" :class="{ 'expanded': commentsExpanded }" width="14" height="14" viewBox="0 0 16 16" fill="none">
                                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>

                            <transition name="comments-expand">
                                <div v-if="commentsExpanded" class="comments-content">
                                    <!-- 排序切换 -->
                                    <div class="comments-sort">
                                        <button
                                            class="sort-btn"
                                            :class="{ 'active': commentSortOrder === 'newest' }"
                                            @click="commentSortOrder = 'newest'"
                                        >
                                            最新
                                        </button>
                                        <button
                                            class="sort-btn"
                                            :class="{ 'active': commentSortOrder === 'oldest' }"
                                            @click="commentSortOrder = 'oldest'"
                                        >
                                            最旧
                                        </button>
                                    </div>

                                    <!-- 评论列表 -->
                                    <div class="comments-list">
                                        <!-- 有评论 -->
                                        <div
                                            v-for="comment in getSortedComments()"
                                            :key="comment.id"
                                            class="comment-item"
                                        >
                                            <div class="comment-bubble">
                                                <p class="comment-text">{{ comment.text }}</p>
                                                <div class="comment-meta">
                                                    <span class="comment-time">{{ formatCommentTime(comment.timestamp) }}</span>
                                                    <button class="comment-delete" @click="deleteComment(comment.id)">
                                                        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                                            <path d="M2 2L12 12M2 12L12 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 空状态 -->
                                        <div v-if="getSelectedNoteComments().length === 0" class="comments-empty">
                                            <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                                                <path d="M24 36V44M24 4V12M40 24H32M16 24H8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                <circle cx="24" cy="24" r="8" stroke="currentColor" stroke-width="2"/>
                                            </svg>
                                            <p>还没有评论，来写第一条吧</p>
                                        </div>
                                    </div>

                                    <!-- 输入区 -->
                                    <div class="comment-input-section">
                                        <div class="comment-input-wrapper">
                                            <input
                                                v-model="newCommentText"
                                                class="comment-input"
                                                placeholder="+ 添加评论..."
                                                @keyup.enter="addComment"
                                                maxlength="280"
                                            >
                                            <button
                                                class="comment-send-btn"
                                                :class="{ 'disabled': !newCommentText.trim() }"
                                                :disabled="!newCommentText.trim()"
                                                @click="addComment"
                                            >
                                                发送
                                            </button>
                                        </div>
                                        <div class="comment-char-counter">
                                            {{ newCommentText.length }}/280
                                        </div>
                                    </div>
                                </div>
                            </transition>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 筛选弹窗 -->
        <transition name="modal">
            <div v-if="showFilterModal" class="modal-backdrop" @click.self="closeFilterModal">
                <div class="filter-modal">
                    <div class="filter-header">
                        <button class="header-btn" @click="resetFilters">重置</button>
                        <h2 class="filter-title">筛选</h2>
                        <button class="header-btn header-btn-primary" @click="applyFilters">完成</button>
                    </div>

                    <div class="filter-content">
                        <!-- 时间筛选 -->
                        <div class="filter-section">
                            <h3 class="filter-section-title">时间</h3>
                            <div class="filter-options">
                                <div
                                    v-for="option in timeFilterOptions"
                                    :key="option.value"
                                    class="filter-option"
                                    :class="{ 'active': filter.time === option.value }"
                                    @click="filter.time = option.value"
                                >
                                    <span class="filter-option-text">{{ option.label }}</span>
                                    <div class="filter-check" v-if="filter.time === option.value">
                                        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                            <path d="M2 7L5 10L12 3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 标签筛选 -->
                        <div class="filter-section">
                            <h3 class="filter-section-title">标签</h3>
                            <div class="filter-tags">
                                <!-- 重要标签（收藏） -->
                                <span
                                    class="filter-tag"
                                    :class="{ 'selected': filter.favorite }"
                                    :style="{ background: filter.favorite ? 'rgba(255,0,0,0.1)' : 'rgba(0,0,0,0.05)' }"
                                    @click="filter.favorite = !filter.favorite"
                                >
                                    <span class="rainbow-text">#重要</span>
                                </span>
                                <!-- 其他标签 -->
                                <span
                                    v-for="tag in allTags"
                                    :key="tag"
                                    class="filter-tag"
                                    :class="{ 'selected': filter.tags.includes(tag) }"
                                    :style="{ color: getTagColor(tag), background: filter.tags.includes(tag) ? getTagColor(tag) + '1A' : 'rgba(0,0,0,0.05)' }"
                                    @click="toggleTagFilter(tag)"
                                >
                                    #{{ tag }}
                                </span>
                                <p v-if="allTags.length === 0 && !filter.favorite" class="filter-empty">暂无标签</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js" defer></script>
    <script src="js/storage.js?v=20250124" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
    <script src="js/app.js?v=20250124" defer></script>

    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(reg => console.log("Service Worker registered"))
                    .catch(err => console.log("Service Worker registration failed: ", err));
            });
        }
    </script>
</body>
</html>
